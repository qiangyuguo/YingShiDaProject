function resizeLeftRight(){$(".auto-quan").each(function(){var b=$(this).find(".auto-right").outerHeight(true);$(this).find(".auto-left").css("height",b+"px")})}function alertDialog(f,d,e){$.dialogs({titleTishi:f,content:d,btnNum:1,okCss:"btn_oranges_primary",title:"orange",ok:function(){if(e!=null||typeof(e)!="undefined"){window.location.href=e}else{return}}})}function setFitAll(i,j){var k=$(i).prop("checked");var h=$(".check-person");var g=0;if(k){$(j+" input[class!='fit_all']").each(function(){var a=$(this).prop("checked");if(!$(this).prop("disabled")){if(!a){$(this).prop("checked",true);g+=parseInt($(this).parent().find(".has-check").html())}}});var l=parseInt($(".check-person").html());checkPersonChange((g+l))}else{$(j+" input[class!='fit_all']").prop("checked",false);checkPersonChange(0)}}function quanF5(){var b=$("#ctx").val();$.post(b+"/kq/choose/coupon",{},function(a){var d="";$.each(a,function(o,c){var t=c.cardType;var p=c.checkPass;var i="";var n="";if(t=="cash"){i="代金券"}else{if(t=="discount"){i="折扣券"}else{if(t=="gift"){i="礼品券"}else{if(t=="groupon"){i="团购券"}else{if(t=="general_coupon"){i="通用券"}}}}}if(p==1){n="审核通过"}else{if(p==0){n="审核未通过"}else{if(p==2){n="审核中"}else{if(p==-1){n="待审核"}}}}var q="";if(c.baseInfo.dateInfoType==1){q=c.baseInfo.dateInfoBeginTimestampStr+"-"+c.baseInfo.dateInfoEndTimestampStr}else{if(c.baseInfo.dateInfoType==2){var r=c.baseInfo.fixedBeginTerm;var s=c.baseInfo.dateInfoFixedTerm;if(c.baseInfo.fixedBeginTerm==null||c.baseInfo.fixedBeginTerm=="null"){r="当"}if(c.baseInfo.dateInfoFixedTerm==null||c.baseInfo.dateInfoFixedTerm=="null"){s="永久"}q="自领取的 "+r+"天开始生效,有效天数 "+s}}d+="<tr><td><span class='green'>"+c.baseInfo.title+"</span></td><td>"+i+"</td><td>"+c.baseInfo.skuQuantity+"</td><td>"+q+"</td><td>"+n+"</td><td><a class='btn btn-primary btn-padding set-name'>选择</a></td><td hidden='hidden'><input class='couponId' type='hidden' value='"+c.id+"'></td><td hidden='hidden'><input class='baseinfoId' type='hidden' value='"+c.baseInfo.id+"'></td><td hidden='hidden'><input class='cardType' type='hidden' value='"+c.cardType+"'></td></tr>"});$("#quan-select table tbody").html(d);$(".set-name").on("click",function(){var m=$(this).closest("tr").find(".green").html();var k=$(this).closest("tr").find(".couponId").val();var c=$(this).closest("tr").find(".baseinfoId").val();var l=$(this).closest("tr").find(".cardType").val();var j=$(".obj-name").val();$("#"+j).next().html(m);var n=$("#autoPage").val();if(n=="auto"){$("#"+j).next().next().val(k);$("#"+j).next().next().next().val(l)}else{if(n=="no_auto"){$("#couponId").val(c);$("#couponId1").val(k);$("#couponType").val(l)}}$("#quan-select").modal("hide");$(".p-top").addClass("hide")})},"json")}function showModal(i,h,g){var j=new Date().getTime();var f=$(i).attr("id");if(typeof(f)=="undefined"){$(i).attr("id",j);$(".obj-name").val(j)}else{$(i).attr("id",f);$(".obj-name").val(f)}if(h){$.post(g+"/kq/choose/coupon",{},function(b){var a="";$.each(b,function(r,c){var w=c.cardType;var s=c.checkPass;var d="";var e="";if(w=="cash"){d="代金券"}else{if(w=="discount"){d="折扣券"}else{if(w=="gift"){d="礼品券"}else{if(w=="groupon"){d="团购券"}else{if(w=="general_coupon"){d="通用券"}}}}}if(s==1){e="审核通过"}else{if(s==0){e="审核未通过"}else{if(s==2){e="审核中"}else{if(s==-1){e="待审核"}}}}var t="";if(c.baseInfo.dateInfoType==1){t=c.baseInfo.dateInfoBeginTimestampStr+"-"+c.baseInfo.dateInfoEndTimestampStr}else{if(c.baseInfo.dateInfoType==2){var u=c.baseInfo.fixedBeginTerm;var v=c.baseInfo.dateInfoFixedTerm;if(c.baseInfo.fixedBeginTerm==null||c.baseInfo.fixedBeginTerm=="null"){u="当"}if(c.baseInfo.dateInfoFixedTerm==null||c.baseInfo.dateInfoFixedTerm=="null"){v="永久"}t="自领取的 "+u+"天开始生效,有效天数 "+v}}a+="<tr><td><span class='green'>"+c.baseInfo.title+"</span></td><td>"+d+"</td><td>"+c.baseInfo.skuQuantity+"</td><td>"+t+"</td><td>"+e+"</td><td><a class='btn btn-primary btn-padding set-name'>选择</a></td><td hidden='hidden'><input class='couponId' type='hidden' value='"+c.id+"'></td><td hidden='hidden'><input class='baseinfoId' type='hidden' value='"+c.baseInfo.id+"'></td><td hidden='hidden'><input class='cardType' type='hidden' value='"+c.cardType+"'></td></tr>"});$("#quan-select table tbody").html(a);$(".set-name").on("click",function(){var o=$(this).closest("tr").find(".green").html();var e=$(this).closest("tr").find(".couponId").val();var c=$(this).closest("tr").find(".baseinfoId").val();var n=$(this).closest("tr").find(".cardType").val();var d=$(".obj-name").val();$("#"+d).next().html(o);var p=$("#autoPage").val();if(p=="auto"){$("#"+d).next().next().val(e);$("#"+d).next().next().next().val(n)}else{if(p=="no_auto"){$("#couponId").val(c);$("#couponId1").val(e);$("#couponType").val(n)}}$("#quan-select").modal("hide");$(".p-top").addClass("hide")})},"json")}$("#quan-select").modal("show")}function selectRight(t,o){var q=$(t);var u=q.closest("tr").find(".status").val();if(u=="Y"){alert("在1个月内已经派过一次，不能选择");return}var p=new Date().getTime();var x=q.attr("id");var w=q.closest("tr").find("input[class='id']").val();var n=q.closest("tr").find(".nickName").html();if(typeof(x)=="undefined"&&q.hasClass("green")){q.attr("id",p).removeClass("green").html("已选择");var s="<li>"+n+' <i class="fa fa-times pull-right" data='+p+' onclick="delPaifa(this,'+o+')"></i><input hidden="hidden" class="customerId" value='+w+"></li>";if(o=="1"){$(".member-ul").append(s)}else{$(".weixin-ul").append(s)}}else{if(typeof(x)!="undefined"&&q.hasClass("green")){q.attr("id",x).removeClass("green").html("已选择");var s="<li>"+n+' <i class="fa fa-times pull-right" data='+x+' onclick="delPaifa(this,'+o+')"></i><input hidden="hidden" class="customerId" value='+w+"></li>";if(o=="1"){$(".member-ul").append(s)}else{$(".weixin-ul").append(s)}}}if(o=="1"){var m=$(".member-ul li").length;$(".member-ul").prev().find(".member-has-xuan").html(m)}else{var v=$(".weixin-ul li").length;$(".weixin-ul").prev().find(".weixin-has-xuan").html(v)}var r=parseInt($(".check-person").html());var r=r+1;checkPersonChange(r)}function delPaifa(k,g){var h=$(k).attr("data");var i=parseInt($(".member-has-xuan").html());var j=parseInt($(".weixin-has-xuan").html());$(k).parent().remove();$("#"+h).html("选择").addClass("green");if(g==1){i=i-1;$(".member-has-xuan").html(i)}else{j=j-1;$(".weixin-has-xuan").html(j)}var l=parseInt($(".check-person").html());var l=l-1;checkPersonChange(l)}function delRule(d){var f=$(d);f.closest("tr").remove();var e=$(".auto-right-zhifu").outerHeight();$(".auto-left-zhifu").css("height",e+"px")}function setHandoutCount(g){var h=parseInt($(g).parent().find(".has-check").html());var e=parseInt($(".check-person").html());var f=$(g).prop("checked");if(f){e=e+h}else{e=e-h}checkPersonChange(e)}function checkPersonChange(b){if(b>0){$("#targetError").html("")}$(".check-person").html(b)}function chooseGroupByMember(){var b=$("#ctx").val();$.post(b+"/kq/handout/targetgroup",{},function(a){var h="";var g=0;var f=0;$.each(a.list,function(d,c){g+=c.handoutCount;f+=c.groupCount;if(c.handoutCount>0){h+="<div class='col-md-4'><label class='checkbox-inline'><input class='groupId' type='checkbox' name='member' value='"+c.id+"' onclick='setHandoutCount(this)'><span>"+c.groupName+"（<span class='has-check'>"+c.handoutCount+"</span>/<span class='all-check'>"+c.groupCount+"</span>）</span></label></div>"}else{h+="<div class='col-md-4'><label class='checkbox-inline'><input class='groupId' disabled type='checkbox' name='member' value='"+c.id+"' onclick='setHandoutCount(this)'><span>"+c.groupName+"（<span class='has-check'>"+c.handoutCount+"</span>/<span class='all-check'>"+c.groupCount+"</span>）</span></label></div>"}});if(g>0){h+='<div class="col-md-12"><label class="checkbox-inline"><input type="checkbox" onclick="setFitAll(this,&quot;.select-content-group&quot;)" class="fit_all"><span>全选（<span class="has-check">'+g+'</span>/<span class="all-check">'+f+"</span>）</span></label></div>"}else{h+='<div class="col-md-12"><label class="checkbox-inline"><input type="checkbox" disabled onclick="setFitAll(this,&quot;.select-content-group&quot;)" class="fit_all"><span>全选（<span class="has-check">'+g+'</span>/<span class="all-check">'+f+"</span>）</span></label></div>"}$("#groupChooseTime").val(a.endTime);$(".membergroup").html(h)},"json")}function chooseGroupByWeixin(){var b=$("#ctx").val();$.post(b+"/kq/handout/followgroup",{},function(a){var e=a.item;var f="";if(e.handoutCount>0){f='<div class="col-md-12"><label class="checkbox-inline"><input type="checkbox"  class="fit_all_fan"><span>'+e.groupName+'（<span class="section-fans">'+e.handoutCount+'</span>/<span class="all-fans">'+e.groupCount+"</span>）</span></label</div>"}else{f='<div class="col-md-12"><label class="checkbox-inline"><input type="checkbox" disabled class="fit_all_fan"><span>'+e.groupName+'（<span class="section-fans">'+e.handoutCount+'</span>/<span class="all-fans">'+e.groupCount+"</span>）</span></label</div>"}$("#groupChooseTime").val(a.endTime);$(".weixingroup").html(f);$(".fit_all_fan").click(function(){if(!$(this).prop("checked")){$(this).prop("checked",false);checkPersonChange(0)}else{$(this).prop("checked",true);var c=$(this).next().find(".section-fans").html();checkPersonChange(c)}})},"json")}$(function(){resizeLeftRight();$(".auto-quan").each(function(){var b=$(this).find(".auto-right").outerHeight(true);$(this).find(".auto-left").css("height",b+"px")});$(".tab-title>li").click(function(){var f=$(this).index();$(".tab-title>li").removeClass("active");$(this).addClass("active");var e=$(this).find("input").val();checkPersonChange(0);$("#customerType").val(e);if(e==1){$(".membergroup input[type='checkbox']").each(function(){$(this).prop("checked",false)})}if(e==2){$(".weixingroup input[type='checkbox']").each(function(){$(this).prop("checked",false)});var d=$("#isFirstWeixinCoupon").val();if(d==1){chooseGroupByWeixin();$("#isFirstWeixinCoupon").val("0")}}$(".tab-contents>div").addClass("hide").eq(f).removeClass("hide");$(".member-ul").html("");$(".weixin-ul").html("");$(".member table tbody").html("");$(".weixin table tbody").html("")});$(".tab-select>li").click(function(){var g=$(this).index();$(this).parent().find("li").removeClass("active");$(this).addClass("active");var e=$("#customerType").val();var f=$(this).find("input").val();$("#handoutType").val(f);if(e==1&&f==1){chooseGroupByMember()}if(e==2&&f==1){chooseGroupByWeixin()}checkPersonChange(0);var h=$(this).parent().next().children("div");h.addClass("hide").eq(g).removeClass("hide");$(".member-ul").html("");$(".weixin-ul").html("");$(".member table tbody").html("");$(".weixin table tbody").html("")});$(".select-content-group input[class!='fit_all']").click(function(){var c=$(".select-content-group input[class!='fit_all']").length;var d=0;$(".select-content-group input[class!='fit_all']").each(function(){if($(this).prop("checked")){d++}});if(c==d){$(".fit_all").prop("checked",true)}else{$(".fit_all").prop("checked",false)}});$(".add-rule").click(function(){var e=$("#ctx").val();var h='<tr class="param"><td><span class="span-price"></span><input type="text" class="form-control" name="price" onchange="validatorInput(this,2)"  value="0"></td>';h+='<td><a class="btn btn-primary btn-padding" onclick="showModal(this,true,&quot;'+e+'&quot;)">选择优惠券</a>';h+='<span class="quan-name"></span><input class="couponId" type="hidden" value=""><input class="couponType" type="hidden" value=""></td><td><span class="error-tips"></span><span class="rule-table del-rule" onclick="delRule(this)";>删除</span></td></tr>';$(this).closest("table").append(h);var g=$(this).closest(".auto-quan");var f=g.find(".auto-right").outerHeight();g.find(".auto-left").css("height",f+"px")});$(".add-rule-count").click(function(){var e=$("#ctx").val();var h='<tr class="param"><td><span class="span-price"></span><input type="text" class="form-control" name="price" onchange="validatorInput(this,2)"  value="0"></td>';h+='<td><a class="btn btn-primary btn-padding" onclick="showModal(this,true,&quot;'+e+'&quot;)">选择优惠券</a>';h+='<span class="quan-name"></span>';h+='<input class="couponId" type="hidden" value=""><input class="couponType" type="hidden" value=""></td>';h+='<td><input type="text" class="choice-num" value="1"></td>';h+='<td><span class="error-tips"></span>';h+='<span class="rule-table del-rule" onclick="delRule(this)";>删除</span></td>';h+="</tr>";$(this).closest("table").append(h);var g=$(this).closest(".auto-quan");var f=g.find(".auto-right").outerHeight();g.find(".auto-left").css("height",f+"px")});$(".set-btn").click(function(){var d=$(this).closest(".auto-quan");var f=$(this).parent().parent();f.find("a").removeClass("hide");$(this).addClass("hide");f.find("div").removeClass("hide");var e=f.outerHeight();d.find(".auto-left").css("height",e+"px")});$(".cancel-btn").click(function(){var d=$(this).closest(".auto-quan");var f=$(this).parent().parent();f.find("#couponsave").addClass("hide");f.find("#couponset").removeClass("hide");$(this).addClass("hide");f.find("div").addClass("hide");var e=f.outerHeight();d.find(".auto-left").css("height",e+"px")});$(".cancel-btn1").click(function(){var d=$(this).closest(".auto-quan");var f=$(this).parent().parent();f.find("#couponsave").addClass("hide");f.find(".edit-btn").removeClass("hide");$(this).addClass("hide");f.find("div").addClass("hide");var e=f.outerHeight();d.find(".auto-left").css("height",e+"px")});$(".btn-add").click(function(){var b=$("#isFirstMemberCoupon").val();if(b==1){chooseGroupByMember();$("#isFirstMemberCoupon").val("0")}$(".delivery,.make-detail").removeClass("hide")});$("#btn-cancel").click(function(){$(".delivery,.make-detail").addClass("hide")})});